name: Automated Pipeline

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    strategy:
      matrix:
        python-version: ["3.12.1"]
        
    steps:
    # checkout code
    - name: Checkout Repository
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Setup Python Environment
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}

    # Install Dependencies
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install numpy opencv-python matplotlib tensorflow flask pylint pytest coverage flask-wtf

    # Build Python package?
    - name: Build the Python package
      run: python -m build --wheel --outdir builds

    # Upload Artifact
    - name: Upload .whl file
      uses: actions/upload-artifact@v3
      with:
        name: image-classifier-wheel
        path: builds/*.whl

    # Linting
    - name: Linting
      run: |
        pylint $(git ls-files '*.py')
      continue-on-error: true

    # Run Model Creation
    - name: Training Model
      run: |
        python model_creation.py

    # OK, SO HERE IS WHERE YOU START OTHER JOBS

    # Run Unit Tests
    - name: Automated Testing
      run: |  
        coverage run -m pytest -v -s


  # IDK WHERE THIS IS ACTUALLY SUPPOSED TO GO TO BUT THIS IS A NEW JOB
  # This is where we use and install the artifact
  use-artifact:
    runs-on: ubuntu-latest
    needs: build
    steps:
      # Download and setup Python Wheel
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: python-wheel
          
      # Install artifact
      - name: Install wheel
        run: pip install image-classifier/*.whl # this might be the wrong path

